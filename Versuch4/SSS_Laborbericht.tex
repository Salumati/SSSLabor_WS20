%---------------
%╔═╗╔═╗╔╦╗╦ ╦╔═╗
%╚═╗║╣  ║ ║ ║╠═╝
%╚═╝╚═╝ ╩ ╚═╝╩
%---------------

% language setup
\newcommand{\docLanguage}{ngerman}
%\newcommand{\docLanguage}{english}

% DOCUMENT SETUP
\documentclass[12pt, oneside, a4paper, \docLanguage]{report}
\usepackage[left=3cm,
			right=2.5cm,
			top=2.5cm,
			bottom=2.5cm,
			includehead,
			includefoot]{geometry}

% line spacing
\usepackage{setspace}
\setstretch{1,25} % 15/12 --> 1.25

% encoding setup
% T1 font encoding for languages that use a latin alphabet
\usepackage[T1]{fontenc}

% enhanced input encoding handling - utf8 for äÄüÜöÖß...
\usepackage[utf8]{inputenc}

%de­fines Adobe Times Ro­man as de­fault text font
\usepackage{mathptmx}
\usepackage{times} % needed for acronym package

%PDF linking package
\usepackage[hidelinks]{hyperref}


% Language Setup
\usepackage[\docLanguage]{babel}
% after babel - set chapter string
\AtBeginDocument{\renewcommand{\chaptername}{}}

% language specific bibliography style
\usepackage[numbers, square]{natbib}
%\setcitestyle{square,aysep={},yysep={;}}
\usepackage{babelbib}
% bliographystyle setup
% babel specific: babplain, babplai3, babalpha, babunsrt, bababbrv, bababbr3
\bibliographystyle{babunsrt}


% enumeration
\usepackage{enumitem}
% tabular extension tabularx
\usepackage{tabularx}

% math packages
\usepackage{amsmath}
\usepackage{nicefrac}
\usepackage{amsthm}
\usepackage{amsbsy}
\usepackage{amssymb}
\usepackage{amsfonts}
%\usepackage{MnSymbol}


%special characters
\usepackage{amssymb}
\usepackage{upgreek,textgreek}

% acronym package
\usepackage[printonlyused, footnote]{acronym}

% breakable text in \seqsplit{}
\usepackage{seqsplit}

% \textmu
\usepackage{textcomp}

% package provides a way to compile sections of a document using the same preamble as the main document
\usepackage{subfiles}

% driver-independent color extension - used by listings,tabularx
\usepackage[usenames,dvipsnames,table,xcdraw]{xcolor}

% -- SYNTAX HIGHLIGHTING --
\usepackage{listings}
%\input{cfgs/listings/listings_def_lang_bash-cmd.tex} % adds style BASH_CMD
%\input{cfgs/listings/listings_def_lang_bash-script.tex} % adds style BASH_SCRIPT
\input{cfgs/listings/listings_def_lang_latex.tex} % adds style LATEX
%\input{cfgs/listings/listings_def_lang_matlab.tex} % adds style MATLAB
\input{cfgs/listings/listings_def_lang_python.tex} % adds style PYTHON
%\input{cfgs/listings/listings_def_lang_c++.tex} % adds style CPP
%\input{cfgs/listings/listings_def_lang_c.tex} % adds style C
%\input{cfgs/listings/listings_def_lang_json.tex} % adds style JSON

% HEADLINE CFG
\usepackage{fancyhdr} % Headers and footers
\usepackage{lastpage}
\usepackage{ifthen}
\setlength{\headheight}{1.5cm}
%\pagestyle{fancy} % All pages have headers and footers
% override plain page style for \part, \chapter or
% \maketitle, which implicit specifies plain page style
\input{cfgs/fancyhdr/fancyhdr_pagestyle_plain.tex}
% set list pagestyle
\input{cfgs/fancyhdr/fancyhdr_pagestyle_preface.tex}
% set default pagestyle
\input{cfgs/fancyhdr/fancyhdr_pagestyle_default_onepage.tex}
%\input{cfgs/fancyhdr/fancyhdr_pagestyle_default_twopage.tex}

\renewcommand{\chaptermark}[1]{\markright{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{#1}{}}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% PICTURE CFG
\usepackage{verbatim}
\usepackage{graphicx}
\usepackage{epstopdf}
\usepackage{caption}
\usepackage[list=true,listformat=simple]{subcaption}
% floating prevention packages
\usepackage{float}    % used with [H] positioning parameter
\usepackage{placeins} % \FloatBarrier
% tikz packages
\usepackage{tikz}
\usepackage{standalone}
\usepackage{pgfplots}


% include only specified tex files - uncommend here
\includeonly{preface/cover,
             preface/abstract,
             preface/tableofcontents,
             preface/listoffigures,
             preface/listoftables,
             preface/lstlistoflistings,
             appendix/bibliography}

%-------------------
%╔═╗╔╦╗╦═╗╦╔╗╔╔═╗╔═╗
%╚═╗ ║ ╠╦╝║║║║║ ╦╚═╗
%╚═╝ ╩ ╩╚═╩╝╚╝╚═╝╚═╝
%-------------------
\newcommand{\strLecture}{Signale, Systeme und Sensoren}
\newcommand{\strDate}{\today}
\newcommand{\strAuthorA}{Sarah Tiefert}
\newcommand{\strAuthorB}{Dominic Fellbaum}
%\newcommand{\strAuthorC}{C. Author}
\newcommand{\strAuthorAEmail}{sarah.tiefert@htwg-konstanz.de}
\newcommand{\strAuthorBEmail}{dominic.fellbaum@htwg-konstanz.de}
%\newcommand{\strAuthorCEmail}{cauthor@htwg-konstanz.de}
% Versuchsbeschreibung
\newcommand{\strTopic}{Versuch 4, Aufbau eines einfachen Spracherkenners }
\newcommand{\strAbstract}{In diesen Versu}
% hyperref customization
\hypersetup{
	pdftitle     = {\strTopic}, % title
	pdfsubject   = {\strLecture}, % subject of the document
	pdfauthor    = {\strAuthorA, \strAuthorB}, % author
	pdfkeywords  = {}, % list of keywords
	pdfcreator   = {}, % creator of the document
	pdfproducer  = {}, % producer of the document
	colorlinks   = false, % false: boxed links; true: colored links
	linkcolor    = red, % color of internal links (change box color with linkbordercolor)
    citecolor    = green, % color of links to bibliography
    filecolor    = magenta, % color of file links
    urlcolor     = cyan, % color of external links
	%bookmarks    = true, % show bookmarks bar?
	unicode	     = true, % non-Latin characters in Acrobat’s bookmarks
	pdftoolbar   = true, % show Acrobat’s toolbar?
	pdfmenubar   = true, % show Acrobat’s menu?
    pdffitwindow = false, % window fit to page when opened
	pdfnewwindow = true % links in new PDF window
}

%-----------------------------------------
% ╔╗ ╔═╗╔═╗╦╔╗╔  ╔╦╗╔═╗╔═╗╦ ╦╔╦╗╔═╗╔╗╔╔╦╗
% ╠╩╗║╣ ║ ╦║║║║   ║║║ ║║  ║ ║║║║║╣ ║║║ ║
% ╚═╝╚═╝╚═╝╩╝╚╝  ═╩╝╚═╝╚═╝╚═╝╩ ╩╚═╝╝╚╝ ╩
%-----------------------------------------

\begin{document}
\pagenumbering{Roman}

\setcounter{section}{0}
\include{preface/cover}

\include{preface/abstract}
\clearpage

%
% TABLE OF CONTENTS
%
\include{preface/tableofcontents}

%
% Abbildungsverzeichnis
%
\include{preface/listoffigures}

%
% Tabellenverzeichnis
%
\include{preface/listoftables}


%--------------------------
% ╔═╗╦ ╦╔═╗╔═╗╔╦╗╔═╗╦═╗╔═╗
% ║  ╠═╣╠═╣╠═╝ ║ ║╣ ╠╦╝╚═╗
% ╚═╝╩ ╩╩ ╩╩   ╩ ╚═╝╩╚═╚═╝
%--------------------------

\pagenumbering{arabic}
\setcounter{page}{1}
\pagestyle{default}
%
% CHAPTER Einleitung
%
\chapter*{Einleitung}
\label{chap:EINL}

In diesem Versuch geht es um den Aufbau eines einfachen Spracherkenners. Dieser soll vier einfache Befehle erkennen und mit ihnen Umgehen können.
Hierfür soll zunächst ein beliebiges längeres Sprachsignal aufgenommen und über Windowing zerlegt werden.

Die Basis hierfür wird durch den Versuch 3 geliefert, in welchen bereits eine Audiodatei aufgenommen und Fouriertransformiert wurde.
Nun wird das Repertoire mit den in der Vorlesungen vorgestellten Methoden des Windowing und der Ähnlichkeitsanalyse erweitert.
Mit diesen soll es möglich sein fastperiodische Signale wie Sprache in ihr Spektrum zu zerlegen, was die Analyse für den Spracherkenner ermöglicht.

Der Spracherkenner soll vier Wörter (“hoch”, “tief”, “links”, “rechts”) voneinander unterscheiden können.


%
% CHAPTER Versuch 1
%

\input{chapters/chapter1.tex}


%
% CHAPTER Versuch 2
%

\input{chapters/chapter2.tex}


%
% CHAPTER Versuch 3
%



%
% CHAPTER Anhang
%
\renewcommand\thesection{A.\arabic{section}}
\renewcommand\thesubsection{\thesection.\arabic{subsection}}

\chapter*{Anhang}
\label{chap:APPENDIX}
\addcontentsline{toc}{chapter}{Anhang}
%\setcounter{chapter}{0}
\addtocounter{chapter}{1}
\setcounter{section}{0}

\section{Quellcode}
\label{chap:APPENDIX_SOURCECODE}


\subsection{imports und konstanten für dateipfade: }


\begin{verbatim}

# -*- coding: utf-8 -*-
import pyaudio
from scipy import signal
import scipy.stats as stats
import numpy as np
import matplotlib.pyplot as plt
import math

FORMAT = pyaudio.paInt16
SAMPLEFREQ = 44100
FRAMESIZE = 1024
NOFRAMES = 220

ABTINTERVALL = 1 / SAMPLEFREQ  # 0.00002267573696145127165  in s
schwellwert = 1500

# paths
pathMedia = "..\media\\"
pathInput = pathMedia + "Sprachinput\\"
pathTest = pathInput + "training\\"

pathHoch = pathInput + "training\Sarah\hoch_t_sarah_"
pathTief = pathInput + "training\Sarah\\tief_t_sarah_"
pathRechts = pathInput + "training\Sarah\\rechts_t_sarah_"
pathLinks = pathInput + "training\Dominic\links_Ref_"

pathRefHoch = pathInput + "mittel_hoch"
pathRefTief = pathInput + "mittel_tief"
pathRefLinks = pathInput + "mittel_links"
pathRefRechts = pathInput + "mittel_rechts"



\end{verbatim}

\subsection{Quellcode vom vorherigen Protokoll:}

\begin{verbatim}
def record(name):
    p = pyaudio.PyAudio()
    stream = p.open(format=FORMAT, channels=1, 
    rate=SAMPLEFREQ, input=True, frames_per_buffer=FRAMESIZE)

    print('start')
    data = stream.read(NOFRAMES * FRAMESIZE)
    decoded = np.fromstring(data, 'Int16')

    stream.stop_stream()
    stream.close()
    p.terminate()

    a = np.asarray(decoded)
    print('done')

    saveData(name, a)
    plotDataAndSaveFig(name)


def recordSeveral(name, number):
    for i in range(number):
        record(str(name) + '_' + str(i))


def saveData(name, yData):
    print("saving")
    yAxis = yData
    xAxis = np.arange(0, len(yData), 1) * ABTINTERVALL

    np.savetxt(str(name) + ".csv", 
    	tuple(zip(xAxis, yAxis)), delimiter=",")
    print("saved")


def plotDataAndSaveFig(name):
    xAxis, yAxis = getDataFromFile(name)
    print(max(yAxis))
    plt.yticks(
    np.arange(min(yAxis), 
    max(yAxis), max(int(max(yAxis) / 10), 1)))
    plt.xticks(np.arange(min(xAxis), max(xAxis), max(xAxis) / 10))

    plt.ylabel('Voltage in mv')
    plt.xlabel('time in s')
    plt.plot(xAxis, yAxis)
    plt.savefig(name + '.png', dpi=900)
    plt.show()


def getDataFromFile(name):
    csv = name + ".csv"
    xAxis = np.genfromtxt(csv, delimiter=",", usecols=0)
    yAxis = np.genfromtxt(csv, delimiter=",", usecols=1)
    return xAxis, yAxis

\end{verbatim}

\subsection{Quellcode Versuch 1}
\label{chap:APPENDIX_SOURCECODE_V1}

\begin{verbatim}
# Cut the signal to voice activation. Length 1 second
def trigger(name):
    xAxis, yAxis = getDataFromFile(name)
    y = np.zeros(SAMPLEFREQ)
    for index in range(len(yAxis)):
        if abs(yAxis[index]) >= schwellwert:
            y = yAxis[index:min(index + SAMPLEFREQ + 1, len(yAxis))]
            break
    while len(y) < SAMPLEFREQ:
        np.concatenate(y, np.zeros(SAMPLEFREQ-len(y)))
        #y = np.pad(y, 1)
        # print("AUFGEFUELLT" + str(len(y)))
    print(len(y))
    saveData(name + "_trigger", y)
    plotDataAndSaveFig(name + "_trigger")


def calculateAmplitudenspektrumAndSaveFig(fileName):
    xData, yData = getDataFromFile(fileName)
    Nhalf = int(xData.size / 2)
    Nval = np.arange(0, Nhalf)
    fourier = np.fft.fft(yData)
    absValues = np.abs(fourier[:Nhalf])

    plt.title('Spektrum')
    plt.xlabel('Frequenz in Hz')
    plt.ylabel('Amplitude')
    plt.plot(Nval[:8000], absValues[:8000])
    plt.savefig('../media/' + fileName + 
    '_Amplitudenspektrum.png', dpi=900)



######
###### WINDOWING
######

def mkchunks(arr, window_function, chunk_size):
    for i in range(0, 
    len(arr) - chunk_size + 1, math.floor(chunk_size / 2)):
    
        yield 
        np.concatenate([[0] * i, 
        list(window_function(arr[i:i + chunk_size])), 
        [0] * (len(arr) - (i + chunk_size))])


def windowedd_fft(data):
    gauss_window = np.array(signal.gaussian(512, 512 / 4))

    windows = np.array(list(mkchunks(data, 
    		lambda d: d * gauss_window, 
    		512)))
    fft = np.fft.rfft(windows).mean(0)
    return fft


def main(fileName):
    x, data = getDataFromFile(fileName)

    data_fft = np.abs(windowedd_fft(data))
    freqs = np.fft.rfftfreq(len(data), 1 / 44100)
    limit = np.argmax(freqs > 1000)

    fig, ax = plt.subplots()
    ax.plot(freqs[1:limit], np.abs(data_fft[1:limit]))
    fig.text(0.5, 0.04, 'Frequenz (Hz)', ha='center', va='center')
    fig.text(0.06, 0.5, 'Amplitude', 
    ha='center', va='center', rotation='vertical')
    plt.savefig('../media/' + fileName + '_Windowing.png', dpi=900)
    plt.show()

    saveData('../media/' + fileName + '_Windowing', data_fft)

\end{verbatim}

\subsection{Quellcode Versuch 2}
\label{chap:APPENDIX_SOURCECODE_V2}

\begin{verbatim}

def calcMean():
    for n in ["hoch", "tief", "rechts", "links"]:
    
        print("..\media\Sprachinput\Ref\\" 
        		+ n + "_Ref_" + str(0) 
        		+ "_trigger_Windowing_Amplitudenspektrum")
        
        x0,n0 = getDataFromFile(
        		"..\media\Sprachinput\Ref\\" 
        		+ n + "_Ref_" 
        		+ str(0) + "_trigger_Windowing")
        
        x1,n1 = getDataFromFile(
        		"..\media\Sprachinput\Ref\\" 
        		+ n + "_Ref_" + str(1) 
        		+ "_trigger_Windowing")        
        
        x2,n2 = getDataFromFile(
        		"..\media\Sprachinput\Ref\\" 
        		+ n + "_Ref_" + str(2) 
        		+ "_trigger_Windowing")
        
        x3,n3 = getDataFromFile(
        		"..\media\Sprachinput\Ref\\" 
        		+ n + "_Ref_" + str(3) 
        		+ "_trigger_Windowing")
        
        x4,n4 = getDataFromFile(
        		"..\media\Sprachinput\Ref\\" 
        		+ n + "_Ref_" 
        		+ str(4) 
        		+ "_trigger_Windowing")
        
        mean = np.mean(np.array([n0, n1, n2, n3, n4]), axis=0)
        saveData("../media/mittel_" + n, mean)
        
        fig, ax = plt.subplots()
        ax.plot(mean)
        fig.text(0.5, 
        		0.04, 
        		'Frequenz (Hz)', 
        		ha='center', 
        		va='center')
        		
        fig.text(0.06, 
        		0.5, 
        		'Amplitude', 
        		ha='center', 
        		va='center', 
        		rotation='vertical')
        		
        plt.savefig('../media/' 
        		+ n 
        		+ '_Windowing_Amplitudenspektrum_Mean.png', 
        		dpi=900)
        plt.show()


def pearson():
    # kovarianz berechnen:
    x1,y1 = getDataFromFile("../media/Sprachinput/mittel_hoch")
    x2,y2 = getDataFromFile(
    "../media/Sprachinput/Ref/hoch_Ref_1_trigger_Windowing")
    cor = np.corrcoef(y1,y2)
    print(cor[0][0])
    print(cor[0][1])
    #0.9125217330177889
    #0.9008457689344428

def kovarianz(data1, data2):
    # 1 Kovarianz berechnen:
    meanData1 = np.mean(data1)
    meanData2 = np.mean(data2)
    return np.mean(np.multiply(
    np.subtract(data1, meanData1), 
    np.subtract(data2, meanData2)))

def bravPears(data1, data2):
    kov = kovarianz(data1, data2)

    # 2 Korrelations Koeffeizienten berechnen:
    stAbw1 = np.std(data1)
    stAbw2 = np.std(data2)
    return np.divide(kov, np.multiply(stAbw1, stAbw2))

def sprachErk(signal):
    # last part
    hoch = getDataFromFile(pathRefHoch)
    tief = getDataFromFile(pathRefTief)
    links = getDataFromFile(pathRefLinks)
    rechts = getDataFromFile(pathRefRechts)

    koHoch = bravPears(signal, hoch)
    koTief = bravPears(signal, tief)
    koLinks = bravPears(signal, links)
    koRechts = bravPears(signal, rechts)

    maxKor = max(koTief, koHoch, koLinks, koRechts)
    """ 
    if maxKor <= 0.2:
        return "Error, word not found"
        """
    if koHoch == maxKor:
        return "HOCH"
    if koTief == maxKor:
        return "TIEF"
    if koLinks == maxKor:
        return "LINKS"
    if koRechts == maxKor:
        return "RECHTS"
    else:
        print(maxKor)
        return "Error, problem in calculation occured"

def test(testSatz):
    genPath = pathTest + testSatz + "\\"

    endD = "Ref_"
    endS = "t_sarah_"
    if (testSatz == "Dominic"):
        end = endD
    else:
        end = endS

    hoch = "hoch"
    tief = "tief"
    links = "links"
    rechts = "rechts"

    correct = 0
    wrong = 0
    print("start testing for data set " + testSatz)
    for d in [hoch, tief, links, rechts]:
        path = genPath + d + "_"
        cCorr = 0
        cWrong = 0
        print("start testing for " + d)
        for i in range(5):
            datax, datay = getDataFromFile(
            path + end + str(i) + "_trigger_Windowing")
            res = sprachErk(datay)
            if res == d.upper():
                cCorr += 1
            else:
                cWrong += 1
                print(res)
        print("done with " + d)
        print("number corr: " 
        		+ str(cCorr) 
        		+ " " + str(cCorr/5 * 100) 
        		+ "%")
        print("number wrong:" 
        		+ str(cWrong) 
        		+ " " 
        		+ str(cWrong/5 * 100) 
        		+ "%")
        correct += cCorr
        wrong += cWrong
    print("\n result for complete test:")
    print("number corr: " 
    + str(correct) + " " 
    + str(correct / 20 * 100) + "%")
    print("number wrong:" + str(wrong) 
    + " " + str(wrong / 20 * 100) + "%")
    print()

\end{verbatim}


%
% Literaturverzeichnis
%
\include{appendix/bibliography}

\end{document}
%------------------------------------
% ╔═╗╔╗╔╔╦╗  ╔╦╗╔═╗╔═╗╦ ╦╔╦╗╔═╗╔╗╔╔╦╗
% ║╣ ║║║ ║║   ║║║ ║║  ║ ║║║║║╣ ║║║ ║
% ╚═╝╝╚╝═╩╝  ═╩╝╚═╝╚═╝╚═╝╩ ╩╚═╝╝╚╝ ╩
%------------------------------------